---
- name: Slurm packages
  dnf:
    name:
      - slurm
      - slurm-slurmctld
      - slurm-devel
    state: present

# - name: slurm user
#   user:
#     name: slurm
#     system: yes

- name: Slurm config directory
  file: state=directory path=/etc/slurm mode=0755

- name: Slurm plugin directory
  file: state=directory path=/usr/lib/slurm mode=0755

- name: Munge config directory
  file: state=directory path=/etc/munge mode=0700 owner=munge group=munge 

- name: Slurm config file
  template: src=slurm.conf.j2 dest=/etc/slurm/slurm.conf
  notify:
   - restart slurmctld

- name: Slurm plugstack config file
  template: src=plugstack.conf.j2 dest=/etc/slurm/plugstack.conf
  notify:
   - restart slurmctld

# FIXME: the layercake-podman plugin should be installed via an RPM
- name: Slurm layercake plugin
  copy:
    src: layercake-podman.so
    dest: /usr/lib/slurm/layercake-podman.so
    owner: root
    group: root
    mode: 0644

- name: Munge key file
  copy: src=munge.key dest=/etc/munge/munge.key mode=0400 owner=munge group=munge
  notify:
   - restart munge

- name: Munge Service
  service: name=munge state=started enabled=yes

- name: Slurm Control Service
  service: name=slurmctld state=started enabled=yes
