variant: fcos
version: 1.4.0
passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - "ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ== vagrant insecure public key"
storage:
  directories:
    - path: /etc/layercake
    - path: /var/layercakepodspool

  files:
    - path: "/etc/NetworkManager/system-connections/Wired connection 2.nmconnection"
      mode: 0600
      contents:
        inline: |
          [connection]
          id=Wired connection 2
          type=ethernet
          autoconnect-priority=-999
          interface-name=ens6

          [ethernet]

          [ipv4]
          address1=192.168.56.103/24
          method=manual

          [ipv6]
          addr-gen-mode=stable-privacy
          method=auto

          [proxy]

    - path: /etc/layercake/munge.key
      mode: 0400
      contents:
        local: munge.key

    - path: /etc/containers/registries.conf
      overwrite: false
      append:
        - inline: |
            [[registry]]
            location = "head:5000"
            insecure = true

    - path: /etc/hosts
      overwrite: false
      append:
        - inline: |
            192.168.56.2    head slurm



systemd:
  units:
    - name: podman.service
      enabled: true

    - name: podman.socket
      enabled: true

    - name: layercake-network.service
      enabled: true
      contents: |
        [Unit]
        Before=systemd-user-sessions.service
        Wants=first-boot-complete.target
        ConditionFirstBoot=true

        [Service]
        Type=oneshot
        ExecStart=podman network create -d macvlan -o parent=ens6 --subnet 192.168.56.0/24 cvlan
        RemainAfterExit=yes

        [Install]
        WantedBy=multi-user.target

    - name: layercake.service
      enabled: true
      contents: |
        [Unit]
        Description=Layercake prep work
        #After=network.target

        [Service]
        Type=oneshot
        ExecStart=mkdir -p /run/layercake/munge
        ExecStart=mkdir -p /tmp/layercakepodtmp
        ExecStart=mkdir -p /etc/layercake
        RemainAfterExit=true
        StandardOutput=journal

        [Install]
        WantedBy=multi-user.target

    - name: layercake-mungekey.service
      enabled: true
      contents: |
        [Unit]
        Description=Create the munge key secret
        After=network-online.target
        ConditionPathExists=!/etc/layercake/mungekeycreated

        [Service]
        Type=oneshot
        ExecStart=podman secret create mungekey /etc/layercake/munge.key
        ExecStart=touch /etc/layercake/mungekeycreated
        RemainAfterExit=true
        StandardOutput=journal

        [Install]
        WantedBy=multi-user.target

    - name: layercake-pod.service
      enabled: true
      contents: |
        # layercake-pod.service
        # autogenerated by Podman 4.1.0
        # Mon Jun  6 22:20:52 UTC 2022

        [Unit]
        Description=Podman layercake-pod.service
        Documentation=man:podman-generate-systemd(1)
        Wants=network-online.target
        After=network-online.target
        RequiresMountsFor=
        Requires=
        Before=

        [Service]
        Environment=PODMAN_SYSTEMD_UNIT=%n
        Restart=on-failure
        TimeoutStopSec=70
        ExecStartPre=/bin/rm -f %t/layercake-pod.pid %t/layercake-pod.pod-id
        ExecStartPre=/usr/bin/podman pod create \
            --infra-conmon-pidfile %t/layercake-pod.pid \
            --pod-id-file %t/layercake-pod.pod-id \
            --name lc03 \
            --share ipc,net,uts,pid \
            --network cvlan -p 6818:6818 \
            --ip 192.168.56.113 \
            --replace
        ExecStart=/usr/bin/podman pod start --pod-id-file %t/layercake-pod.pod-id
        ExecStop=/usr/bin/podman pod stop --ignore --pod-id-file %t/layercake-pod.pod-id -t 10
        ExecStopPost=/usr/bin/podman pod rm --ignore -f --pod-id-file %t/layercake-pod.pod-id
        PIDFile=%t/layercake-pod.pid
        Type=forking

        [Install]
        WantedBy=default.target

    - name: layercake-munged.service
      enabled: true
      contents: |
        # layercake-munged.service
        # autogenerated by Podman 4.1.0
        # Mon Jun  6 21:40:17 UTC 2022

        [Unit]
        Description=Podman layercake-munged.service
        Documentation=man:podman-generate-systemd(1)
        Wants=network-online.target
        After=network-online.target
        RequiresMountsFor=%t/containers

        [Service]
        Environment=PODMAN_SYSTEMD_UNIT=%n
        Restart=on-failure
        TimeoutStopSec=70
        ExecStartPre=/bin/rm -f %t/%n.ctr-id
        ExecStart=/usr/bin/podman run \
          --cidfile=%t/%n.ctr-id \
          --cgroups=no-conmon \
          --rm \
          --sdnotify=conmon \
          -d \
          --replace \
          -ti \
          --pod lc03 \
          -v /tmp/layercakepodtmp:/tmp:z \
          -v /run/layercake/munge:/run/munge:z \
          --secret mungekey \
          --name munged head:5000/munged
        ExecStop=/usr/bin/podman stop --ignore --cidfile=%t/%n.ctr-id
        ExecStopPost=/usr/bin/podman rm -f --ignore --cidfile=%t/%n.ctr-id
        Type=notify
        NotifyAccess=all

        [Install]
        WantedBy=default.target

    - name: layercake-slurmd.service
      enabled: true
      contents: |
        # layercake-slurmd.service
        # autogenerated by Podman 4.1.0
        # Mon Jun  6 20:54:09 UTC 2022

        [Unit]
        Description=Podman layercake-slurmd.service
        Documentation=man:podman-generate-systemd(1)
        Wants=network-online.target
        After=network-online.target
        RequiresMountsFor=%t/containers

        [Service]
        Environment=PODMAN_SYSTEMD_UNIT=%n
        Restart=on-failure
        TimeoutStopSec=70
        ExecStartPre=/bin/rm -f %t/%n.ctr-id
        ExecStart=/usr/bin/podman run \
          --cidfile=%t/%n.ctr-id \
          --cgroups=no-conmon \
          --rm \
          --sdnotify=conmon \
          -d \
          --replace \
          -ti \
          --privileged \
          --pod lc03 \
          --name slurmd \
          -v /tmp/layercakepodtmp:/tmp:z \
          -v /run/layercake/munge:/run/munge:z \
          -v /var/layercakepodspool:/var/spool:z \
          -v /run/layercake:/run/layercake:z \
          -v /run/podman/podman.sock:/run/layercake/podman.sock:z \
          -v /home:/home \
          head:5000/slurmd
        ExecStop=/usr/bin/podman stop --ignore --cidfile=%t/%n.ctr-id
        ExecStopPost=/usr/bin/podman rm -f --ignore --cidfile=%t/%n.ctr-id
        Type=notify
        NotifyAccess=all

        [Install]
        WantedBy=default.target
